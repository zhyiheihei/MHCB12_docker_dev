name: Build and Push Docker Image

# 触发条件：main/master 分支的推送或 release 发布
on:
  push:
    branches: [ main, master ]
  release:
    types: [published]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 根据触发事件类型确定 Docker 镜像标签
      - name: Determine Docker tags
        id: determine-tags
        run: |
          # 如果是 release 事件，使用版本号作为标签
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "::notice::Building RELEASE version: $TAG_NAME"
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "push_latest=true" >> $GITHUB_OUTPUT
          # 如果是 push 事件，使用 latest 标签
          else
            echo "::notice::Building DEV version with latest tag"
            echo "tag_name=latest" >> $GITHUB_OUTPUT
            echo "push_latest=false" >> $GITHUB_OUTPUT
          fi

      # 配置 SSH 代理用于私有仓库克隆
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 构建 Docker 镜像，同时为 Docker Hub 和阿里云 ACR 打标签
      - name: Build Docker Image
        run: |
          # 定义镜像名称
          LOCAL_IMAGE=${{ vars.DOCKER_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}
          ACR_IMAGE=registry.cn-hangzhou.aliyuncs.com/${{ vars.ALIYUN_ACR_NAMESPACE }}/${{ vars.DOCKER_IMAGE_NAME }}

          # 构建镜像并同时标记两个仓库的标签
          docker build \
            --ssh default=$SSH_AUTH_SOCK \
            --build-arg REPO_URL="git@codeup.aliyun.com:dooya/MHCB12.git" \
            -t $LOCAL_IMAGE:${{ steps.determine-tags.outputs.tag_name }} \
            -t $ACR_IMAGE:${{ steps.determine-tags.outputs.tag_name }} \
            .

          # Release 版本时，额外添加 latest 标签
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            docker tag $LOCAL_IMAGE:${{ steps.determine-tags.outputs.tag_name }} $LOCAL_IMAGE:latest
            docker tag $ACR_IMAGE:${{ steps.determine-tags.outputs.tag_name }} $ACR_IMAGE:latest
          fi

      # 登录 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 推送镜像到 Docker Hub
      - name: Push to Docker Hub
        run: |
          # 推送主标签镜像
          docker push ${{ vars.DOCKER_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ steps.determine-tags.outputs.tag_name }}
          
          # Release 版本时，同时推送 latest 标签
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            docker push ${{ vars.DOCKER_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:latest
          fi

      # 登录阿里云 ACR
      - name: Login to Aliyun ACR
        uses: docker/login-action@v2
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}

      # 推送镜像到阿里云 ACR
      - name: Push to Aliyun ACR
        run: |
          ACR_IMAGE=registry.cn-hangzhou.aliyuncs.com/${{ vars.ALIYUN_ACR_NAMESPACE }}/${{ vars.DOCKER_IMAGE_NAME }}
          # 推送主标签镜像
          docker push $ACR_IMAGE:${{ steps.determine-tags.outputs.tag_name }}
          
          # Release 版本时，同时推送 latest 标签
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            docker push $ACR_IMAGE:latest
          fi