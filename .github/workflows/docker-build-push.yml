# 简化版Docker镜像构建和推送工作流
# 必要配置：在仓库Settings > Secrets and variables中添加以下项
# Secrets:
# - DOCKER_PASSWORD: Docker Hub访问令牌
# 可选配置（根据需要添加）:
# - DOCKER_USERNAME: Docker Hub用户名（不设置时使用仓库所有者）
# - DOCKER_IMAGE_NAME: 镜像名（不设置时使用仓库名）

name: Build and Push Docker Image

# 触发条件：main/master 分支的推送或 release 发布
on:
  push:
    branches: [ main, master ]
  release:
    types: [published]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: docker-builder  # 指定使用docker-builder环境的密钥
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 确定Docker标签
      - name: Determine Docker tags
        id: determine-tags
        run: |
          # 根据事件类型设置标签
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "构建发布版本: $TAG_NAME"
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "push_latest=true" >> $GITHUB_OUTPUT
          else
            echo "构建开发版本，使用latest标签"
            echo "tag_name=latest" >> $GITHUB_OUTPUT
            echo "push_latest=false" >> $GITHUB_OUTPUT
          fi

      # 设置环境变量，简化版
      - name: Set environment variables
        id: set-vars
        run: |
          # Docker用户名（优先使用变量，否则使用仓库所有者）
          DOCKER_USERNAME=${{ vars.DOCKER_USERNAME || github.repository_owner }}
          echo "docker_username=$DOCKER_USERNAME" >> $GITHUB_OUTPUT
          
          # 镜像名
          DOCKER_IMAGE_NAME=${{ vars.DOCKER_IMAGE_NAME}}
          echo "docker_image_name=$DOCKER_IMAGE_NAME" >> $GITHUB_OUTPUT
          
          # 检查是否有SSH密钥
          HAS_SSH=false
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            HAS_SSH=true
          fi
          echo "has_ssh=$HAS_SSH" >> $GITHUB_OUTPUT
          
          # 验证必要的密钥
          if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "错误：缺少DOCKER_PASSWORD密钥，请在GitHub仓库设置中添加Docker Hub访问令牌"
            exit 1
          fi

      # 配置SSH代理（添加错误处理和容错机制）
      - name: Setup SSH Agent
        id: ssh-agent
        if: ${{ steps.set-vars.outputs.has_ssh == 'true' }}
        uses: webfactory/ssh-agent@v0.8.0
        continue-on-error: true
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      # 验证SSH代理设置（增强错误处理）
      - name: Verify SSH Setup
        id: verify-ssh
        if: ${{ steps.set-vars.outputs.has_ssh == 'true' }}
        run: |
          echo "检查SSH代理状态..."
          if [ -n "$SSH_AUTH_SOCK" ]; then
            echo "SSH_AUTH_SOCK 可用: $SSH_AUTH_SOCK"
            # 尝试列出密钥，但不使失败影响工作流
            ssh-add -L > /dev/null 2>&1
            if [ $? -eq 0 ]; then
              echo "SSH密钥加载成功"
              echo "has_valid_ssh=true" >> $GITHUB_OUTPUT
            else
              echo "警告: SSH密钥加载失败，但将继续执行工作流"
              echo "has_valid_ssh=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "警告: SSH_AUTH_SOCK 环境变量不存在"
            echo "has_valid_ssh=false" >> $GITHUB_OUTPUT
          fi
          
          # 为可能的库错误提供额外信息
          echo "系统环境信息:"
          ssh -V || echo "无法获取SSH版本"
          openssl version || echo "无法获取OpenSSL版本"

      # 构建Docker镜像
      - name: Build Docker Image
        run: |
          # 设置基础变量
          LOCAL_IMAGE=${{ steps.set-vars.outputs.docker_username }}/${{ steps.set-vars.outputs.docker_image_name }}
          TAG_NAME=${{ steps.determine-tags.outputs.tag_name }}
          
          # SSH参数（改进错误处理和验证）
          SSH_ARG=""
          
          # 检查是否有SSH配置且密钥有效
          HAS_VALID_SSH=false
          if [ "${{ steps.verify-ssh.outputs.has_valid_ssh }}" = "true" ]; then
            HAS_VALID_SSH=true
          elif [ "${{ steps.set-vars.outputs.has_ssh }}" = "true" ] && [ -n "$SSH_AUTH_SOCK" ]; then
            # 后备检查，即使验证失败也尝试使用
            echo "尝试使用SSH代理，尽管验证可能失败"
            HAS_VALID_SSH=true
          fi
          
          if [ "$HAS_VALID_SSH" = "true" ]; then
            SSH_ARG="--ssh default=$SSH_AUTH_SOCK"
            echo "尝试使用SSH代理进行构建"
            # 确保正确设置构建上下文
            export DOCKER_BUILDKIT=1
            echo "DOCKER_BUILDKIT已启用"
          else
            echo "未使用SSH代理进行构建"
            echo "注意：由于SSH密钥加载错误(libcrypto)，将使用Dockerfile中的回退机制"
            # 对于构建上下文，我们依赖于Dockerfile中已添加的备用克隆方法
          fi
          
          # 阿里云ACR镜像名称（如果配置了）
          ACR_NAMESPACE=${{ vars.ALIYUN_ACR_NAMESPACE || '' }}
          ACR_IMAGE=""
          if [ -n "$ACR_NAMESPACE" ]; then
            ACR_IMAGE="registry.cn-hangzhou.aliyuncs.com/$ACR_NAMESPACE/${{ steps.set-vars.outputs.docker_image_name }}"
          fi
          
          # 构建镜像
          echo "构建镜像: $LOCAL_IMAGE:$TAG_NAME"
          docker build $SSH_ARG \
            --build-arg REPO_URL="${{ vars.REPO_URL || 'git@codeup.aliyun.com:dooya/MHCB12.git' }}" \
            -t $LOCAL_IMAGE:$TAG_NAME \
            ${ACR_IMAGE:+-t $ACR_IMAGE:$TAG_NAME} \
            .
          
          # 如果是Release版本，添加latest标签
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            echo "添加latest标签"
            docker tag $LOCAL_IMAGE:$TAG_NAME $LOCAL_IMAGE:latest
            if [ -n "$ACR_IMAGE" ]; then
              docker tag $ACR_IMAGE:$TAG_NAME $ACR_IMAGE:latest
            fi
          fi

      # 登录Docker Hub并推送镜像
      - name: Push to Docker Hub
        run: |
          # 登录Docker Hub
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ steps.set-vars.outputs.docker_username }} --password-stdin
          
          # 推送镜像
          IMAGE_NAME=${{ steps.set-vars.outputs.docker_username }}/${{ steps.set-vars.outputs.docker_image_name }}
          echo "推送镜像: $IMAGE_NAME:${{ steps.determine-tags.outputs.tag_name }}"
          docker push $IMAGE_NAME:${{ steps.determine-tags.outputs.tag_name }}
          
          # 推送latest标签（仅发布版本）
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            echo "推送latest标签"
            docker push $IMAGE_NAME:latest
          fi

      # 推送镜像到阿里云ACR（如果配置了）
      - name: Push to Aliyun ACR
        if: ${{ vars.ALIYUN_ACR_NAMESPACE != '' }}
        run: |
          # 登录阿里云ACR
          echo "${{ secrets.ALIYUN_ACR_PASSWORD }}" | docker login registry.cn-hangzhou.aliyuncs.com -u ${{ secrets.ALIYUN_ACR_USERNAME }} --password-stdin
          # 推送镜像
          ACR_IMAGE="registry.cn-hangzhou.aliyuncs.com/${{ vars.ALIYUN_ACR_NAMESPACE }}/${{ steps.set-vars.outputs.docker_image_name }}"
          echo "推送镜像到阿里云ACR: $ACR_IMAGE:${{ steps.determine-tags.outputs.tag_name }}"
          docker push $ACR_IMAGE:${{ steps.determine-tags.outputs.tag_name }}
          
          # 推送latest标签（仅发布版本）
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            echo "推送latest标签到阿里云ACR"
            docker push $ACR_IMAGE:latest
          fi