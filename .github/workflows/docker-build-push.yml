# 简化版Docker镜像构建和推送工作流
# 必要配置：在仓库Settings > Secrets and variables中添加以下项
# Secrets:
# - DOCKER_PASSWORD: Docker Hub访问令牌
# 可选配置（根据需要添加）:
# - DOCKER_USERNAME: Docker Hub用户名（不设置时使用仓库所有者）
# - DOCKER_IMAGE_NAME: 镜像名（不设置时使用仓库名）

name: Build and Push Docker Image

# 触发条件：main/master 分支的推送或 release 发布
on:
  push:
    branches: [ main, master ]
  release:
    types: [published]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: docker-builder  # 指定使用docker-builder环境的密钥
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 确定Docker标签
      - name: Determine Docker tags
        id: determine-tags
        run: |
          # 根据事件类型设置标签
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "构建发布版本: $TAG_NAME"
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "push_latest=true" >> $GITHUB_OUTPUT
          else
            echo "构建开发版本，使用latest标签"
            echo "tag_name=latest" >> $GITHUB_OUTPUT
            echo "push_latest=false" >> $GITHUB_OUTPUT
          fi

      # 设置环境变量，简化版
      - name: Set environment variables
        id: set-vars
        run: |
          # Docker用户名（优先使用变量，否则使用仓库所有者）
          DOCKER_USERNAME=${{ vars.DOCKER_USERNAME || github.repository_owner }}
          echo "docker_username=$DOCKER_USERNAME" >> $GITHUB_OUTPUT
          
          # 镜像名
          DOCKER_IMAGE_NAME=${{ vars.DOCKER_IMAGE_NAME || 'mhcb12' }}
          echo "docker_image_name=$DOCKER_IMAGE_NAME" >> $GITHUB_OUTPUT
          
          # 检查是否有SSH密钥
          HAS_SSH=false
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            HAS_SSH=true
          fi
          echo "has_ssh=$HAS_SSH" >> $GITHUB_OUTPUT
          
          # 验证必要的密钥
          if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "错误：缺少DOCKER_PASSWORD密钥，请在GitHub仓库设置中添加Docker Hub访问令牌"
            exit 1
          fi

      # 配置SSH代理（更可靠的密钥处理）
      - name: Setup SSH Agent
        id: ssh-agent
        if: ${{ steps.set-vars.outputs.has_ssh == 'true' }}
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      # 验证SSH代理设置（添加详细诊断信息）
      - name: Verify SSH Setup
        if: ${{ steps.set-vars.outputs.has_ssh == 'true' }}
        run: |
          echo "SSH_AUTH_SOCK: $SSH_AUTH_SOCK"
          echo "SSH配置信息:"
          ssh-add -L || echo "没有可用的SSH密钥"
          echo "尝试连接GitHub测试SSH..."
          ssh -T git@github.com || true
          echo "尝试连接阿里云代码平台..."
          ssh -T git@codeup.aliyun.com || echo "阿里云代码平台连接失败（预期行为）"

      # 构建Docker镜像
      - name: Build Docker Image
        run: |
          # 设置基础变量
          LOCAL_IMAGE=${{ steps.set-vars.outputs.docker_username }}/${{ steps.set-vars.outputs.docker_image_name }}
          TAG_NAME=${{ steps.determine-tags.outputs.tag_name }}
          
          # SSH参数（优化配置，确保密钥正确传递）
          SSH_ARG=""
          if [ "${{ steps.set-vars.outputs.has_ssh }}" = "true" ] && [ -n "$SSH_AUTH_SOCK" ]; then
            SSH_ARG="--ssh default=$SSH_AUTH_SOCK"
            echo "使用SSH代理进行构建: $SSH_AUTH_SOCK"
            # 确保正确设置构建上下文
            export DOCKER_BUILDKIT=1
            echo "DOCKER_BUILDKIT已启用"
          else
            echo "未使用SSH代理进行构建"
            echo "注意：如果需要克隆私有仓库，请确保提供了有效的SSH_PRIVATE_KEY密钥"
          fi
          
          # 阿里云ACR镜像名称（如果配置了）
          ACR_NAMESPACE=${{ vars.ALIYUN_ACR_NAMESPACE || '' }}
          ACR_IMAGE=""
          if [ -n "$ACR_NAMESPACE" ]; then
            ACR_IMAGE="registry.cn-hangzhou.aliyuncs.com/$ACR_NAMESPACE/${{ steps.set-vars.outputs.docker_image_name }}"
          fi
          
          # 构建镜像
          echo "构建镜像: $LOCAL_IMAGE:$TAG_NAME"
          docker build $SSH_ARG \
            --build-arg REPO_URL="${{ vars.REPO_URL || 'git@codeup.aliyun.com:dooya/MHCB12.git' }}" \
            -t $LOCAL_IMAGE:$TAG_NAME \
            ${ACR_IMAGE:+-t $ACR_IMAGE:$TAG_NAME} \
            .
          
          # 如果是Release版本，添加latest标签
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            echo "添加latest标签"
            docker tag $LOCAL_IMAGE:$TAG_NAME $LOCAL_IMAGE:latest
            if [ -n "$ACR_IMAGE" ]; then
              docker tag $ACR_IMAGE:$TAG_NAME $ACR_IMAGE:latest
            fi
          fi

      # 登录Docker Hub并推送镜像
      - name: Push to Docker Hub
        run: |
          # 登录Docker Hub
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ steps.set-vars.outputs.docker_username }} --password-stdin
          
          # 推送镜像
          IMAGE_NAME=${{ steps.set-vars.outputs.docker_username }}/${{ steps.set-vars.outputs.docker_image_name }}
          echo "推送镜像: $IMAGE_NAME:${{ steps.determine-tags.outputs.tag_name }}"
          docker push $IMAGE_NAME:${{ steps.determine-tags.outputs.tag_name }}
          
          # 推送latest标签（仅发布版本）
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            echo "推送latest标签"
            docker push $IMAGE_NAME:latest
          fi

      # 推送镜像到阿里云ACR（如果配置了）
      - name: Push to Aliyun ACR
        if: ${{ vars.ALIYUN_ACR_NAMESPACE != '' }}
        run: |
          # 登录阿里云ACR
          echo "${{ secrets.ALIYUN_ACR_PASSWORD }}" | docker login registry.cn-hangzhou.aliyuncs.com -u ${{ secrets.ALIYUN_ACR_USERNAME }} --password-stdin
          # 推送镜像
          ACR_IMAGE="registry.cn-hangzhou.aliyuncs.com/${{ vars.ALIYUN_ACR_NAMESPACE }}/${{ steps.set-vars.outputs.docker_image_name }}"
          echo "推送镜像到阿里云ACR: $ACR_IMAGE:${{ steps.determine-tags.outputs.tag_name }}"
          docker push $ACR_IMAGE:${{ steps.determine-tags.outputs.tag_name }}
          
          # 推送latest标签（仅发布版本）
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            echo "推送latest标签到阿里云ACR"
            docker push $ACR_IMAGE:latest
          fi