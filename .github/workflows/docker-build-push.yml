# 说明：请在仓库 Settings > Secrets and variables 中添加以下项
# Secrets（仅限 Actions 可见，存放敏感凭据）：
# - SSH_PRIVATE_KEY         : 私有仓库的 SSH 私钥（用于 webfactory/ssh-agent）
# - DOCKER_PASSWORD         : Docker Hub 的访问令牌/密码
# - ALIYUN_ACR_USERNAME     : 阿里云 ACR 登录用户名（若为子账号）
# - ALIYUN_ACR_PASSWORD     : 阿里云 ACR 登录密码/密码
#
# Variables（非敏感，可在 Actions 日志中显示，便于复用）：
# - DOCKER_USERNAME         : Docker Hub 用户名（用于镜像命名和登录）
# - DOCKER_IMAGE_NAME       : 镜像名（例如 mhcb12）
# - ALIYUN_ACR_NAMESPACE    : 阿里云 ACR 命名空间（例如 my-namespace）
# - REPO_URL (可选)         : 构建时的仓库地址（可用于 --build-arg）

name: Build and Push Docker Image

# 触发条件：main/master 分支的推送或 release 发布
on:
  push:
    branches: [ main, master ]
  release:
    types: [published]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 根据触发事件类型确定 Docker 镜像标签
      - name: Determine Docker tags
        id: determine-tags
        run: |
          # 如果是 release 事件，使用版本号作为标签
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "::notice::Building RELEASE version: $TAG_NAME"
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "push_latest=true" >> $GITHUB_OUTPUT
          # 如果是 push 事件，使用 latest 标签
          else
            echo "::notice::Building DEV version with latest tag"
            echo "tag_name=latest" >> $GITHUB_OUTPUT
            echo "push_latest=false" >> $GITHUB_OUTPUT
          fi

      # 校验必要的 Secrets/Variables，缺少则失败并给出清晰提示
      - name: Validate required secrets and variables
        run: |
          MISSING=false
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "::error::Secret SSH_PRIVATE_KEY is not set. Add it in Settings > Secrets and variables > Actions."
            MISSING=true
          fi
          if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "::error::Secret DOCKER_PASSWORD is not set. Add Docker Hub access token as DOCKER_PASSWORD."
            MISSING=true
          fi
          if [ -z "${{ secrets.ALIYUN_ACR_PASSWORD }}" ]; then
            echo "::warning::Secret ALIYUN_ACR_PASSWORD is not set. If you push to Aliyun ACR, you must set it."
            MISSING=true
          fi
          if [ -z "${{ vars.DOCKER_USERNAME }}" ]; then
            echo "::error::Variable DOCKER_USERNAME is not set. Add it in Settings > Secrets and variables > Variables."
            MISSING=true
          fi
          if [ -z "${{ vars.DOCKER_IMAGE_NAME }}" ]; then
            echo "::error::Variable DOCKER_IMAGE_NAME is not set."
            MISSING=true
          fi
          if [ "$MISSING" = "true" ]; then
            echo "One or more required secrets/variables are missing. See errors above."
            exit 1
          fi

      # 配置 SSH 代理用于私有仓库克隆（仅当 SSH_PRIVATE_KEY 存在时执行）
      - name: Setup SSH Agent
        if: ${{ secrets.SSH_PRIVATE_KEY != '' }}
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 构建 Docker 镜像，同时为 Docker Hub 和阿里云 ACR 打标签
      - name: Build Docker Image
        run: |
          # 定义镜像名称
          LOCAL_IMAGE=${{ vars.DOCKER_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}
          ACR_IMAGE=registry.cn-hangzhou.aliyuncs.com/${{ vars.ALIYUN_ACR_NAMESPACE }}/${{ vars.DOCKER_IMAGE_NAME }}

          # 构建镜像并同时标记两个仓库的标签
          docker build \
            --ssh default=$SSH_AUTH_SOCK \
            --build-arg REPO_URL="git@codeup.aliyun.com:dooya/MHCB12.git" \
            -t $LOCAL_IMAGE:${{ steps.determine-tags.outputs.tag_name }} \
            -t $ACR_IMAGE:${{ steps.determine-tags.outputs.tag_name }} \
            .

          # Release 版本时，额外添加 latest 标签
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            docker tag $LOCAL_IMAGE:${{ steps.determine-tags.outputs.tag_name }} $LOCAL_IMAGE:latest
            docker tag $ACR_IMAGE:${{ steps.determine-tags.outputs.tag_name }} $ACR_IMAGE:latest
          fi

      # 登录 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          # Docker Hub 用户名建议作为仓库 Variable (vars)，非敏感信息
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 推送镜像到 Docker Hub
      - name: Push to Docker Hub
        run: |
          # 推送主标签镜像
          docker push ${{ vars.DOCKER_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ steps.determine-tags.outputs.tag_name }}
          
          # Release 版本时，同时推送 latest 标签
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            docker push ${{ vars.DOCKER_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:latest
          fi

      # 登录阿里云 ACR
      - name: Login to Aliyun ACR
        uses: docker/login-action@v2
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}

      # 推送镜像到阿里云 ACR
      - name: Push to Aliyun ACR
        run: |
          ACR_IMAGE=registry.cn-hangzhou.aliyuncs.com/${{ vars.ALIYUN_ACR_NAMESPACE }}/${{ vars.DOCKER_IMAGE_NAME }}
          # 推送主标签镜像
          docker push $ACR_IMAGE:${{ steps.determine-tags.outputs.tag_name }}
          
          # Release 版本时，同时推送 latest 标签
          if [ "${{ steps.determine-tags.outputs.push_latest }}" = "true" ]; then
            docker push $ACR_IMAGE:latest
          fi